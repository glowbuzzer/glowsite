import {Tldr} from "../../framework/components/Tldr"
import { Link } from "react-router-dom"
import {Image} from "../../framework/components/Image"
import CraTemplate from "../fragments/cra_template.mdx"
import InstallGbc from "../fragments/install_gbc.mdx"
import RunGbc from "../fragments/run_gbc_short.mdx"
import FrontendConnect from "../fragments/frontend_connect.mdx"

# {props.subtitle}

<Tldr>
    - Short guide to building React components to control machines
    - Tutorial 1 - Toggle a digital output
    - Tutorial 2 - Oscillating move on a drive
</Tldr>

## Introduction
This document takes you though installing the glowbuzzer's toolkit React components and creating some simple machine control functions of your own.

## Use the CRA template to create your own starter project

<CraTemplate/>

## Structure of the project
We provide a little framework that enables a Tiled UI to be created.

You don't have to use this framework, we use it because often machine control user interfaces contain discrete "pockets" of functionality laid out on the screen.

For this tutorial, we will assume that you are using the Tiles.

## Create new tile that toggles a Digital Output - Front-end Tutorial 1

### Introduction
Let's create the simplest possible machine control function. A button to toggle a digital output. This is the "hello world" equivalent in automation land.

### Create the tile
Start by creating a new tsx file `TutorialDoToggleTile.tsx`.

In this file we need to import the components we will need for our new tile.

```tsx
//TutorialDoToggleTile.tsx
import React from "react"
import { Tile } from "@glowbuzzer/layout"
import { Switch} from "antd"
import styled from "styled-components"
import { useDigitalOutput} from "@glowbuzzer/store"

```

`React` & `styled-components` are the React and <a href="https://styled-components.com/"> styled-components</a> are the imports for the React components and styled-components is a handy way of styling a React application that we use widely.

`Tile` is the component we provide to help assemble tiled user interfaces.

useDigitalOutput is the glowbuzzer toolkit component that integrates with the Digital IO.

Switch is the component we will use for our switch from the Ant Design framework (<a href="https://ant.design/components/switch/">Switch Component</a>)

The `useDigitalOutput` component from the glowbuzzer toolkit has the following signature:

````jsx title="/src/components/HelloCodeTitle.js"
function useDigitalOutput(index: number): {set(state: number, override?: boolean): void, actState: number, state: number, override?: boolean): void, actState: number, state: number, override: boolean}
````

It enables you to both set the state of a digital output and also provides its state (i.e. if it is set or unset).

So, we need to write a component that sets the state of the digital output when the toggle switch is manipulated.

For this tutorial we will use digital ouput number 1.

A little function handles the state change and applies the new state to the digital output.

The tile's user interface is as simple as it gets, it is just the Ant Design Switch component.

The code for this is as follows:

```tsx
export const TutorialDoToggleTile = ({ labels=[] }) => {
    const dout = useDigitalOutput(1)

    function handle_state_change() {
        const new_state = 1 - dout.state
        dout.set(new_state, true)
    }

    return (
       <Tile title="Tutorial Digital Output Toggle">
           <StyledDiv>
                Turn on my digital output
                <Switch checked={dout.state && true} onChange={handle_state_change}/>
           </StyledDiv>
       </Tile>
    )
}
````


The final code is:

```tsx
import React from "react"
import { Tile } from "@glowbuzzer/layout"
import { Select, Switch, Tag } from "antd"
import styled from "styled-components"
import { useDigitalOutput, useDigitalOutputList } from "@glowbuzzer/store"


const StyledDiv = styled.div`
padding-top: 20px;

    > div {
        display: flex;
        gap: 10px;
    }
     .ant-switch {
        flex-grow: 1;
        margin: 10px 20px;
    }
`

export const TutorialDoToggleTile = ({ labels=[] }) => {
    const dout = useDigitalOutput(1)

    function handle_state_change() {
        const new_state = 1 - dout.state
        dout.set(new_state, true)
    }

    return (
       <Tile title="Tutorial Digital Output Toggle">
           <StyledDiv>
                Turn on my digital output
                <Switch checked={dout.state && true} onChange={handle_state_change}/>
           </StyledDiv>
       </Tile>
    )
}
```

### Add the tile to the UI

In app.tsx, import the component you just wrote:
```tsx
import {TutorialDoToggleTile} from "./tutorial/TutorialDoToggleTile";
```

Then render it on the page at the appropriate point:

```tsx
//app.tsx
{ render: <TutorialDoToggleTile />, height: 4, title: "Tutorial Digital Output Toggle" }
```


Now when you look at localhost:xxxx you will see your tile and the toggle switch.

import step1_add_switch from "./front_end_tutorial_images/step1_add_switch.png?glowsite"

<Image meta={step1_add_switch} alt="front-end switch" maxWidth={400}/>


### Test the toggle switch

The next step is to make the toggle switch actually trigger a digital output.

To do this we need to install GBC.

<InstallGbc/>

And then run GBC/

<RunGbc/>

And finally connect the front-end to GBC.

<FrontendConnect/>

We will be running in `Simulation Mode` as we have not integrated GBC with any hardware (e.g. an EtherCAT master).

Now, in the UI, the glowbuzzer provided Digital Outputs tile reflects the state of all the digital outputs and you will be able to see Digital Output 1 toggle as your move your switch.

That is it. It shows how simple it is to create React components to control machine functions.

## Make a drive move - an oscillating move -  Front-end Tutorial 2

### Introduction
The next example in showing how easy it is to write React machine control functions is to make a drive move. In this case we want to make a drive perform an oscillating move.

### Create the tile

Create `TutorialOscillatingMoveTile.tsx` in the project you created with the custom template.

We will use a `soloActivity` to perform the move. Everything you get back is promise based so to create and oscillating move, we can `await` the completion of a move.



```tsx
//TutorialOscillatingMoveTile.tsx
// import React, {createContext, FC, useContext, useRef, useState} from "react"
import { useSoloActivity } from '@glowbuzzer/store';
import {Tile} from "@glowbuzzer/layout";
import {Button} from "antd";

export const TutorialOscillatingMoveTile = () => {
    const [complete, setComplete] = useState(false)
    const soloActivity = useSoloActivity(0)

    async function do_promise() {
        setComplete(false)
        await soloActivity.moveJoints([1000,0,0]).promise()
        await soloActivity.moveJoints([0,0,0]).promise()
        await soloActivity.moveJoints([1000,0,0]).promise()
        await soloActivity.moveJoints([0,0,0]).promise()
        setComplete(true)
    }

    return (
        <Tile title="Test Oscillating move">
            <Button onClick={do_promise}>Start Move</Button>
            {complete ? "Move complete" : ""}
        </Tile>
    )
}
```

### Add the tile to the UI

In app.tsx, import the component you just wrote:
```tsx
import {TutorialDoToggleTile} from "./tutorial/TutorialOscillatingMoveTile";
```

Then render it on the page at the appropriate point:


```tsx
//app.tsx
{ render: <TutorialOscillatingMoveTile />, height: 4, title: "Tutorial Oscillating Move" }
```



When you view your site you should now see your tile.

import oscillating_move_tile from "./front_end_tutorial_images/oscillating_move_tile.png?glowsite"

<Image meta={oscillating_move_tile} alt="Oscillating move tile" maxWidth={400}/>



### Test the oscillating move

The next step is to test the move.

You will need to run GBC (see the previous Tutorial for details on how to do this).

Then, in the browser, click connect to establish a connection to GBC.

Then make sure the machine state is "Operation Enabled" by clicking the `Operate` button (after clearing any faults).

Now when we click the Start move button, in the Joints Tile, we will see our drive spinning.

import oscillating_move_running from "./front_end_tutorial_images/oscillating_move_running.png?glowsite"

<Image meta={oscillating_move_running} alt="Oscillating move running"/>

